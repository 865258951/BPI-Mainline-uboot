name: Build U-Boot

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: u-boot/u-boot
          ref: v2024.01

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-linux-gnueabihf bison flex python3 python3-dev python3-setuptools swig libssl-dev bc device-tree-compiler

      - name: Build Berry Safe Version (384MHz)
        run: |
          # 配置 Banana Pi M2 Berry (A40i/V40)
          make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bananapi_m2_berry_defconfig
          
          # --- 核心修改：降频保平安 ---
          # 强制将内存频率降到 384MHz (甚至更低 360 也行，这里先用 384)
          sed -i 's/CONFIG_DRAM_CLK=.*/CONFIG_DRAM_CLK=384/' .config
          
          # 开启 UMS (U盘模式)
          echo "CONFIG_CMD_USB_MASS_STORAGE=y" >> .config
          echo "CONFIG_USB_MUSB_GADGET=y" >> .config
          echo "CONFIG_USB_GADGET=y" >> .config
          echo "CONFIG_USB_GADGET_DOWNLOAD=y" >> .config
          echo "CONFIG_USB_MUSB_SUNXI=y" >> .config
          
          # 编译
          make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- olddefconfig
          make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j$(nproc)
          
          # 检查文件是否生成
          if [ -f "u-boot-sunxi-with-spl.bin" ]; then
            echo "Build Success!"
          else
            echo "Error: File not found!"
            exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: u-boot-safe-berry
          path: u-boot-sunxi-with-spl.bin
